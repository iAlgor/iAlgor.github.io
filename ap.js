//
// AXON PORTABLE
//

"use strict";!async function(){const t=window.WebSocket,e=[55,3,170,32,65,27,9,128];class n{constructor(t){this.data=t}writeIndex(t,n){const r=this.data[n],o=r+4&7,a=255&(r<<o|r>>>8-o);if(n>0){const r=t[n-1]^e[n];t.push(a^r)}else t.push(e[0]^a)}build(){const t=[];for(let e=0;e<8;e++)this.writeIndex(t,e);const e=Math.floor((Math.pow(2,32)-1)*Math.random());return t.push(255&(t[0]^e>>>24)),t.push(255&(t[1]^e>>>16)),t.push(255&(t[2]^e>>>8)),t.push(255&(e^t[3])),t.push(t[0]),t}}class r{constructor(t,e){t instanceof DataView?(this.id=t.id,this.dataView=t):this.dataView=new DataView(t),this.offset=e||0}reallocateIfNeeded(t){const e=this.offset+t;if(e>this.length){const t=new ArrayBuffer(e);new Uint8Array(t).set(new Uint8Array(this.buffer)),this.dataView=new DataView(t)}}static fromSize(t){return new this(new ArrayBuffer(t))}get buffer(){return this.dataView.buffer}get length(){return this.dataView.byteLength}get eof(){return this.offset>=this.length}read(t,e,n,r){const o=t.call(this.dataView,r||this.offset,n);return r||(this.offset+=e),o}write(t,e,n,r){this.reallocateIfNeeded(e),t.call(this.dataView,this.offset,n,r),this.offset+=e}readInt8(t){return this.read(DataView.prototype.getInt8,1,null,t)}readUInt8(t){return this.read(DataView.prototype.getUint8,1,null,t)}readInt16LE(t){return this.read(DataView.prototype.getInt16,2,!0,t)}readInt16BE(t){return this.read(DataView.prototype.getInt16,2,!1,t)}readUInt16LE(t){return this.read(DataView.prototype.getUint16,2,!0,t)}readUInt16BE(t){return this.read(DataView.prototype.getUint16,2,!1,t)}readInt32LE(t){return this.read(DataView.prototype.getInt32,4,!0,t)}readInt32BE(t){return this.read(DataView.prototype.getInt32,4,!1,t)}readUInt32LE(t){return this.read(DataView.prototype.getUint32,4,!0,t)}readUInt32BE(t){return this.read(DataView.prototype.getUint32,4,!1,t)}readString16(){let t,e="";for(;t=this.readUInt16LE();!this.eof&&0!==t)e+=String.fromCharCode(t);return e}readString(){let t,e="";for(;t=this.readUInt8();!this.eof&&0!==t)e+=String.fromCharCode(t);return e}readEscapedString(){return decodeURIComponent(escape(this.readString()))}writeInt8(t){this.write(DataView.prototype.setInt8,1,t,null)}writeUInt8(t){this.write(DataView.prototype.setUint8,1,t,null)}writeInt16LE(t){this.write(DataView.prototype.setInt16,2,t,!0)}writeInt16BE(t){this.write(DataView.prototype.setInt16,2,t,!1)}writeUInt16LE(t){this.write(DataView.prototype.setUint16,2,t,!0)}writeUInt16BE(t){this.write(DataView.prototype.setUint16,2,t,!1)}writeInt32LE(t){this.write(DataView.prototype.setInt32,4,t,!0)}writeInt32BE(t){this.write(DataView.prototype.setInt32,4,t,!1)}writeUInt32LE(t){this.write(DataView.prototype.setUint32,4,t,!0)}writeUInt32BE(t){this.write(DataView.prototype.setUint32,4,t,!1)}writeString(t){for(const e in t)this.writeUInt8(t.charCodeAt(e))}writeStringNT(t){this.writeString(t),this.writeUInt8(0)}writeEscapedString(t){this.writeString(unescape(encodeURIComponent(t)))}writeEscapedStringNT(t){this.writeStringNT(unescape(encodeURIComponent(t)))}}const{game:o,settings:a,Swal:i,adManager:s}=await new Promise(t=>{Function.prototype.call=new Proxy(Function.prototype.call,{apply(e){if(3===arguments.length){const n=arguments[2];if(Array.isArray(n)&&4===n.length){const r=n[3];"function"==typeof r&&Array.isArray(r.m)&&(Function.prototype.call=e,t({game:r(1),settings:r(4),Swal:r(5),adManager:r(77)}))}}return Reflect.apply(...arguments)}})});o.shouldAutoRespawn=(()=>a.autoRespawn&&!o.app.showMenu),window.gameObj=o,s.loadAdinplay=(()=>{}),s.loadMenuAds=(()=>{}),s.refreshAd=(()=>!1);const c=t=>{const e=document.getElementById(t);return e.parentElement.removeChild(e)};let d;c("vanis-io_300x250"),c("vanis-io_728x90"),c("vanis-io_300x250_2"),o.start=new Proxy(o.start,{apply(){Reflect.apply(...arguments),a.autoReconnect&&(o.retryCount=0),d=1500;const{selectedServer:t}=o.state;t&&"string"==typeof t.name&&t.name.startsWith("OVT")&&(d=1e4)}}),o.tick=(()=>{o.timestamp=Date.now(),o.timestamp>=o.moveWaitUntil&&(o.updateMouse(),o.splitCount=0);let t=o.removedNodes.length;for(;t--;){const e=o.removedNodes[t];e.update()&&(e.destroySprite(),o.removedNodes.splice(t,1))}let e=0;o.nodelist.forEach(t=>{t.update(),t.pid===o.activePid&&e++}),o.cellCount!==e&&(o.cellCount=e,o.events.$emit("cells-changed",e)),o.scene.sort();const n=o.updateCamera();n?(o.score=n,o.highscore=Math.max(n,o.highscore||0)):(o.score=0,delete o.highscore),o.renderer.render(o.scene.container)});const p=(t,e)=>{i.toast.fire({type:t,title:e,timer:"error"===t?5e3:2e3})},h=()=>{delete o.currentWsId,o.connection.opened=!1,p("error","Failed to establish a connection with the server")};a.autoReconnect&&(o.retryCount=0);const l=t=>{if(delete o.currentWsId,o.connection.opened=!1,o.running&&o.stop(),1003===t.code)setTimeout(()=>{o.connection.opened||o.events.$emit("reconnect-server")},1500),p("info","Server restarting...");else if(a.autoReconnect)++o.retryCount>=30?p("error","Too many rejoin attempts"):(p("info","Reconnecting to server..."),setTimeout(()=>{o.connection.opened||o.events.$emit("reconnect-server")},3200));else{let e="You have been disconnected";t.reason&&(e+=" (".concat(t.reason,")")),p("error",e)}o.showMenu(!0)};let u;const w=t=>{const e=new r(t.data);switch(e.readUInt8()){case 2:{const t=new Uint8Array(e.buffer,1);o.connection.sendJoinData(new n(t).build());break}case 4:for(;;){const t=e.readUInt16LE();if(0===t)break;o.playerManager.delayedRemovePlayer(t)}case 20:{const t=e.readUInt16LE(),n=e.readUInt16LE(),r=e.readUInt32LE();if(o.state.deathScreen=!0,o.app.deathStats={timeAlive:t,killCount:n,highscore:r},a.autoRespawn&&!o.app.showMenu){o.state.isAutoRespawning=!0;let t=d/1e3;const e=setInterval(()=>{t=Math.max(t-.1,0),o.events.$emit("update-cautions",{custom:0!==t?"Respawning in ".concat(t.toFixed(1)):u}),0===t&&clearInterval(e)},100)}const i=o.state.isAutoRespawning?d:900;o.deathTimeout=setTimeout(o.triggerAutoRespawn,i);break}case 25:u=e.readString16(),o.events.$emit("update-cautions",{custom:u});break;default:return void o.parseMessage(e.dataView)}};let f=0;o.connection.open=(e=>{o.running&&o.stop(),o.connection.close(),o.events.$emit("chat-clear"),o.connection.opened=!0;const n=o.ws=new t(e,"tFoL46WDlZuRja7W6qCl");n.binaryType="arraybuffer",n.packetId=0,n.onopen=(()=>{o.currentWsId=n.id=f++,o.state.connectionUrl=e,n.onclose=l}),n.onclose=h,n.onmessage=w}),o.getThumbnail=(()=>{const t=240,e=135,n=o.scene.container,r=new PIXI.Container;r.pivot.x=n.position.x,r.pivot.y=n.position.y,r.position.x=120,r.position.y=e/2,r.scale.set(.25),r.addChild(n);const i=PIXI.RenderTexture.create(t,e);o.renderer.render(r,i),r.removeChild(n);const s=o.renderer.plugins.extract.canvas(i),c=document.createElement("canvas");c.width=t,c.height=e;const d=c.getContext("2d");d.beginPath(),d.rect(0,0,t,e),d.fillStyle="#".concat(a.backgroundColor),d.fill(),d.drawImage(s,0,0,t,e);const p=c.toDataURL();return r.destroy(!0),p}),p("info","Axon portable has loaded")}();
